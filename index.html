<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Planning Application</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@material-ui/core@4.12.4/umd/material-ui.development.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .strategic-planning-suite {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .header {
            background-color: #2a4365;
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            background-color: #edf2f7;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 8px;
        }
        .nav-tabs button {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-tabs button.bg-blue-600 {
            background-color: #3182ce;
            color: white;
            box-shadow: 0 2px 8px rgba(49, 130, 206, 0.3);
        }
        .nav-tabs button:hover:not(.bg-blue-600) {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        .tab-content {
            padding: 30px;
        }
        .form-section {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
            outline: none;
        }
        .button-primary {
            background-color: #3182ce;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .button-primary:hover {
            background-color: #2b6cb0;
        }
        .button-secondary {
            background-color: #e2e8f0;
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .button-secondary:hover {
            background-color: #cbd5e0;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .collapsible-header:hover {
            background-color: #edf2f7;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 1000px; /* Arbitrarily large value to allow content to expand */
            transition: max-height 0.5s ease-in;
        }
        .collapsible-content-inner {
            padding: 20px;
        }
        .gut-score-critical {
            background-color: #f56565; /* Red-500 */
            color: white;
        }
        .gut-score-high {
            background-color: #f6ad55; /* Orange-400 */
            color: white;
        }
        .gut-score-medium {
            background-color: #ecc94b; /* Yellow-400 */
            color: #333;
        }
        .gut-score-low {
            background-color: #68d391; /* Green-400 */
            color: white;
        }
        .risk-high {
            background-color: #e53e3e; /* Red-600 */
            color: white;
        }
        .risk-medium {
            background-color: #dd6b20; /* Orange-600 */
            color: white;
        }
        .risk-low {
            background-color: #38a169; /* Green-600 */
            color: white;
        }
    </style>
</head>
<body>
    <div id="artifact_react"></div>
    <div id="error-container"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const companySuggestions = [
            'Apple Inc.', 'Microsoft Corporation', 'Amazon.com Inc.', 'Alphabet Inc.', 'Tesla Inc.',
            'Meta Platforms Inc.', 'Netflix Inc.', 'Salesforce Inc.', 'Adobe Inc.', 'Oracle Corporation',
            'Commonwealth Bank of Australia', 'Westpac Banking Corporation', 'ANZ Banking Group',
            'National Australia Bank', 'Telstra Corporation', 'BHP Group', 'CSL Limited',
            'Woolworths Group', 'Wesfarmers Limited', 'Macquarie Group', 'Atlassian Corporation',
            'Toyota Motor Corporation', 'Samsung Electronics Co. Ltd.', 'Sony Group Corporation',
            'General Motors', 'Ford Motor Company', 'Volkswagen AG', 'NestlÃ© S.A.', 'Procter & Gamble',
            'Johnson & Johnson', 'Pfizer Inc.', 'Novartis AG', 'Roche Holding AG', 'JPMorgan Chase & Co.',
            'Bank of America', 'Citigroup Inc.', 'HSBC Holdings plc', 'Industrial and Commercial Bank of China'
        ];

        const industrySuggestions = [
            "Technology", "Healthcare", "Finance", "Retail", "Automotive", "Energy", "Telecommunications",
            "Consumer Goods", "Manufacturing", "Aerospace & Defense", "Utilities", "Real Estate",
            "Transportation", "Hospitality", "Media & Entertainment", "Education", "Construction",
            "Agriculture", "Pharmaceuticals", "Biotechnology", "Food & Beverage", "Chemicals",
            "Metals & Mining", "Textiles", "Logistics", "Consulting", "Marketing", "Advertising",
            "Software", "Hardware", "Semiconductors", "E-commerce", "Fintech", "Biotech", "Medtech",
            "Renewable Energy", "Oil & Gas", "Electric Utilities", "Water Utilities", "Waste Management",
            "Commercial Banking", "Investment Banking", "Asset Management", "Insurance", "Brokerage",
            "Residential Real Estate", "Commercial Real Estate", "Industrial Real Estate",
            "Airlines", "Railways", "Shipping", "Trucking", "Public Transportation",
            "Hotels", "Restaurants", "Travel Agencies", "Theme Parks", "Casinos",
            "Film Production", "Music Industry", "Publishing", "Broadcasting", "Gaming",
            "K-12 Education", "Higher Education", "Vocational Training", "E-learning",
            "Residential Construction", "Commercial Construction", "Heavy Construction",
            "Crop Production", "Livestock", "Fishing", "Forestry",
            "Specialty Chemicals", "Commodity Chemicals", "Industrial Gases", "Paints & Coatings",
            "Precious Metals", "Industrial Metals", "Coal", "Iron Ore",
            "Apparel", "Footwear", "Home Furnishings", "Luxury Goods",
            "Freight Forwarding", "Warehousing", "Courier Services", "Supply Chain Management"
        ];

        function App() {
            const [currentPhase, setCurrentPhase] = useState('company-info');
            const [companyData, setCompanyData] = useState({
                name: '',
                industry: '',
                primaryMarket: '',
                businessModel: '',
                size: '',
                revenue: '',
                description: '',
                foundedYear: '',
                headquarters: '',
                website: '',
                keyProducts: [],
                missionStatement: '',
                visionStatement: '',
                coreValues: [],
                keyExecutives: []
            });

            const [companyPestelData, setCompanyPestelData] = useState({
                political: { factors: [], isCollapsed: false },
                economic: { factors: [], isCollapsed: false },
                social: { factors: [], isCollapsed: false },
                technological: { factors: [], isCollapsed: false },
                environmental: { factors: [], isCollapsed: false },
                legal: { factors: [], isCollapsed: false }
            });

            const [productPestels, setProductPestels] = useState({});
            const [selectedPestelScope, setSelectedPestelScope] = useState('company'); // 'company' or product name
            const [editingFactor, setEditingFactor] = useState(null);

            const [showCompanySuggestions, setShowCompanySuggestions] = useState(false);
            const [filteredCompanySuggestions, setFilteredCompanySuggestions] = useState([]);
            const companyNameRef = useRef(null);

            const [showIndustrySuggestions, setShowIndustrySuggestions] = useState(false);
            const [filteredIndustrySuggestions, setFilteredIndustrySuggestions] = useState([]);
            const industryRef = useRef(null);

            const [isCompanyNameEditing, setIsCompanyNameEditing] = useState(false);
            const [isFoundedYearEditing, setIsFoundedYearEditing] = useState(false);
            const [isIndustryEditing, setIsIndustryEditing] = useState(false);
            const [isPrimaryMarketEditing, setIsPrimaryMarketEditing] = useState(false);
            const [isBusinessModelEditing, setIsBusinessModelEditing] = useState(false);
            const [isSizeEditing, setIsSizeEditing] = useState(false);
            const [isRevenueEditing, setIsRevenueEditing] = useState(false);
            const [isHeadquartersEditing, setIsHeadquartersEditing] = useState(false);
            const [isWebsiteEditing, setIsWebsiteEditing] = useState(false);
            const [isDescriptionEditing, setIsDescriptionEditing] = useState(false);
            const [factorFieldEditStates, setFactorFieldEditStates] = useState({}); // For PESTEL factor field editing

            // State for the new editable list UI component (will be used later)
            // const [customList, setCustomList] = useState([]); 

            const [selectedPortersScope, setSelectedPortersScope] = useState('company');
            const [productPortersForces, setProductPortersForces] = useState({});
            const [portersDescriptionEditStates, setPortersDescriptionEditStates] = useState({});

            const [competitors, setCompetitors] = useState([]); // For "Internal Issues" tab
            const [newCompetitorsList, setNewCompetitorsList] = useState([]); // For "Competitors Analysis" tab
            
            const [selectedPersonaScope, setSelectedPersonaScope] = useState('company');
            const [companyPersonas, setCompanyPersonas] = useState([]);
            const [productPersonas, setProductPersonas] = useState({});

            const [portersForces, setPortersForces] = useState({
                threatOfNewEntrants: { description: '', gravity: 3, urgency: 3, tendency: 3 },
                bargainingPowerOfBuyers: { description: '', gravity: 3, urgency: 3, tendency: 3 },
                bargainingPowerOfSuppliers: { description: '', gravity: 3, urgency: 3, tendency: 3 },
                threatOfSubstituteProductsOrServices: { description: '', gravity: 3, urgency: 3, tendency: 3 },
                rivalryAmongExistingCompetitors: { description: '', gravity: 3, urgency: 3, tendency: 3 },
                relativePowerOfNewComplementors: { description: '', gravity: 3, urgency: 3, tendency: 3 }
            });

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (companyNameRef.current && !companyNameRef.current.contains(event.target)) {
                        setShowCompanySuggestions(false);
                    }
                    if (industryRef.current && !industryRef.current.contains(event.target)) {
                        setShowIndustrySuggestions(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            useEffect(() => {
                // Auto-populate COMPANY Porter's Forces when industry or primary market changes
                if (companyData.industry || companyData.primaryMarket) {
                    // Only update company-level forces automatically. Product-specific forces are initialized or manually suggested.
                    setPortersForces(generatePortersForces(companyData.industry, companyData.primaryMarket));
                }
            }, [companyData.industry, companyData.primaryMarket]);

            useEffect(() => {
                // Initialize product-specific Porter's forces when scope changes to a product
                // and it hasn't been initialized yet.
                if (selectedPortersScope !== 'company' && !productPortersForces[selectedPortersScope]) {
                    console.log(`Initializing Porter's forces for product: ${selectedPortersScope}`);
                    const companyForcesDeepCopy = JSON.parse(JSON.stringify(portersForces));
                    setProductPortersForces(prev => ({
                        ...prev,
                        [selectedPortersScope]: companyForcesDeepCopy
                    }));
                }
            }, [selectedPortersScope, portersForces, productPortersForces]);
            
            useEffect(() => {
                // Initialize product-specific Personas when scope changes to a product
                // and it hasn't been initialized yet. Defaults to a copy of company personas or empty array.
                if (selectedPersonaScope !== 'company' && !productPersonas[selectedPersonaScope]) {
                    console.log(`Initializing Personas for product: ${selectedPersonaScope}`);
                    const companyPersonasDeepCopy = companyPersonas.length > 0 ? JSON.parse(JSON.stringify(companyPersonas)) : [];
                    setProductPersonas(prev => ({
                        ...prev,
                        [selectedPersonaScope]: companyPersonasDeepCopy
                    }));
                }
            }, [selectedPersonaScope, companyPersonas, productPersonas]);


            const phases = [
                { id: 'company-info', name: 'Company Info', icon: 'fas fa-building' },
                { id: 'pestel', name: 'PESTEL Analysis', icon: 'fas fa-globe' },
                { id: 'porter', name: 'Porter\'s Six Forces', icon: 'fas fa-chess' },
                { id: 'competitors-analysis', name: 'Competitors Analysis', icon: 'fas fa-users-viewfinder' },
                { id: 'clients-personas', name: 'Clients Personas', icon: 'fas fa-address-book' },
                { id: 'competitor', name: 'Internal Issues', icon: 'fas fa-users' },
                { id: 'swot', name: 'SWOT Analysis', icon: 'fas fa-chart-line' },
                { id: 'customer', name: 'Customer Segmentation', icon: 'fas fa-user-friends' },
                { id: 'integration', name: 'Integration & Insights', icon: 'fas fa-link' }
            ];

            const initializeProductPestel = (productName) => {
                if (!productPestels[productName]) {
                    const initialProductPestel = {};
                    Object.entries(companyPestelData).forEach(([category, data]) => {
                        initialProductPestel[category] = {
                            factors: data.factors.map(factor => ({ ...factor })),
                            isCollapsed: false
                        };
                    });
                    setProductPestels(prev => ({
                        ...prev,
                        [productName]: initialProductPestel
                    }));
                }
            };

            const handleCompanyNameChange = (value) => {
                setCompanyData(prev => ({ ...prev, name: value }));
                if (value.length > 0) {
                    const filtered = companySuggestions.filter(company =>
                        company.toLowerCase().includes(value.toLowerCase())
                    );
                    setFilteredCompanySuggestions(filtered);
                    setShowCompanySuggestions(filtered.length > 0);
                } else {
                    setShowCompanySuggestions(false);
                    setFilteredCompanySuggestions([]);
                }
            };

            const selectCompanySuggestion = (company) => {
                setCompanyData(prev => ({ ...prev, name: company }));
                setShowCompanySuggestions(false);
                setFilteredCompanySuggestions([]);
            };

            const handleIndustryChange = (value) => {
                setCompanyData(prev => ({ ...prev, industry: value }));
                if (value.length > 0) {
                    const filtered = industrySuggestions.filter(industry =>
                        industry.toLowerCase().includes(value.toLowerCase())
                    );
                    setFilteredIndustrySuggestions(filtered);
                    setShowIndustrySuggestions(filtered.length > 0);
                } else {
                    setShowIndustrySuggestions(false);
                    setFilteredIndustrySuggestions([]);
                }
            };

            const selectIndustrySuggestion = (industry) => {
                setCompanyData(prev => ({ ...prev, industry: industry }));
                setShowIndustrySuggestions(false);
                setFilteredIndustrySuggestions([]);
            };

            const addArrayItem = (setter, currentArray, newItem, fieldName) => {
                if (newItem.trim()) {
                    const newArray = [...currentArray, newItem.trim()];
                    setter(prev => ({ ...prev, [fieldName]: newArray }));

                    if (fieldName === 'keyProducts') {
                        initializeProductPestel(newItem.trim());
                    }
                }
            };

            const removeArrayItem = (setter, currentArray, index, fieldName) => {
                const itemToRemove = currentArray[index];
                const newArray = currentArray.filter((_, i) => i !== index);
                setter(prev => ({ ...prev, [fieldName]: newArray }));

                if (fieldName === 'keyProducts') {
                    setProductPestels(prev => {
                        const updated = { ...prev };
                        delete updated[itemToRemove];
                        return updated;
                    });
                    if (selectedPestelScope === itemToRemove) {
                        setSelectedPestelScope('company');
                    }
                }
            };

            const researchCompany = async () => {
                const companyName = companyData.name.trim();
                if (!companyName) {
                    alert('Please enter a company name first');
                    return;
                }

                try {
                    setCompanyData(prev => ({ ...prev, description: 'ðŸ” Researching company information...' }));
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate delay

                    const researchedData = generateCompanyData(companyName);
                    const companyPestelAnalysis = generateCompanyPestelData(companyName, researchedData.industry);
                    const generatedCompetitors = generateCompetitors(companyName);
                    const generatedPortersForces = generatePortersForces(researchedData.industry, researchedData.primaryMarket);

                    setCompanyData(prev => ({
                        ...prev,
                        ...researchedData,
                        name: companyName // Ensure the original name is kept
                    }));
                    setCompanyPestelData(companyPestelAnalysis);
                    setCompetitors(generatedCompetitors);
                    setPortersForces(generatedPortersForces);

                    const newProductPestels = {};
                    researchedData.keyProducts.forEach(product => {
                        const initialProductPestel = {};
                        Object.entries(companyPestelAnalysis).forEach(([category, data]) => {
                            initialProductPestel[category] = {
                                factors: data.factors.map(factor => ({ ...factor })),
                                isCollapsed: false
                            };
                        });
                        newProductPestels[product] = initialProductPestel;
                    });
                    setProductPestels(newProductPestels);

                    alert(`âœ… Research completed! Found comprehensive information for ${companyName}.`);

                } catch (error) {
                    console.error('Research error:', error);
                    alert('âŒ Research failed. Please try again or enter information manually.');
                    setCompanyData(prev => ({ ...prev, description: '' }));
                }
            };

            const generateCompanyData = (companyName) => {
                const industries = ['Technology', 'Healthcare', 'Finance', 'Retail', 'Manufacturing', 'Education'];
                const markets = ['Australia', 'United States', 'Global', 'Asia-Pacific', 'Europe'];
                const businessModels = ['B2B', 'B2C', 'SaaS', 'E-commerce', 'Marketplace'];
                const sizes = ['startup', 'small', 'medium', 'large', 'enterprise'];

                const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
                const currentYear = new Date().getFullYear();

                return {
                    industry: randomChoice(industries),
                    primaryMarket: randomChoice(markets),
                    businessModel: randomChoice(businessModels),
                    size: randomChoice(sizes),
                    revenue: `$${Math.floor(Math.random() * 1000) + 10}M`,
                    foundedYear: (currentYear - Math.floor(Math.random() * 30) - 5).toString(),
                    headquarters: `${randomChoice(['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'San Francisco', 'New York'])}, ${randomChoice(['Australia', 'USA', 'UK'])}`,
                    website: `https://www.${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}.com`,
                    description: `${companyName} is a leading company in the ${randomChoice(industries).toLowerCase()} sector, providing innovative solutions to customers worldwide.`,
                    missionStatement: `To deliver exceptional value through innovative ${randomChoice(['products', 'services', 'solutions'])} that transform how businesses operate.`,
                    visionStatement: `To be the global leader in ${randomChoice(['innovation', 'customer satisfaction', 'sustainable growth'])}, setting new standards for excellence.`,
                    keyProducts: [
                        `${companyName} Core Platform`,
                        `${companyName} Analytics Suite`,
                        `${companyName} Mobile Application`,
                        `${companyName} Professional Services`
                    ],
                    coreValues: ['Innovation', 'Integrity', 'Customer Focus', 'Excellence', 'Collaboration'],
                    keyExecutives: [
                        'John Smith - Chief Executive Officer',
                        'Sarah Johnson - Chief Technology Officer',
                        'Michael Brown - Chief Financial Officer',
                        'Emily Davis - Chief Operating Officer'
                    ]
                };
            };

            const generateCompanyPestelData = (companyName, industry, size, primaryMarket) => {
                let baseFactors = {
                    political: [
                        { name: 'General Election Cycle Impact', gravity: 3, urgency: 3, tendency: 4, description: 'Potential policy shifts post-election affecting business operations.' },
                        { name: 'International Trade Agreements', gravity: 4, urgency: 2, tendency: 3, description: 'Changes in trade tariffs or agreements impacting export/import.' },
                    ],
                    economic: [
                        { name: 'Inflation Rate Trends', gravity: 4, urgency: 4, tendency: 4, description: 'Rising inflation affecting operational costs and consumer spending.' },
                        { name: 'Currency Exchange Rate Stability', gravity: 3, urgency: 3, tendency: 3, description: 'Fluctuations in currency value impacting international business.' },
                    ],
                    social: [
                        { name: 'Evolving Consumer Ethics & Values', gravity: 4, urgency: 4, tendency: 5, description: 'Shift towards sustainability and ethical sourcing influencing demand.' },
                        { name: 'Workforce Skill Gaps', gravity: 3, urgency: 4, tendency: 3, description: 'Difficulty in finding talent with specialized skills.' },
                    ],
                    technological: [
                        { name: 'Advancements in AI/ML', gravity: 5, urgency: 5, tendency: 5, description: 'Rapid AI development creating opportunities and disruption.' },
                        { name: '5G Network Rollout', gravity: 4, urgency: 3, tendency: 4, description: 'Enhanced connectivity enabling new services and operational efficiencies.' },
                    ],
                    environmental: [
                        { name: 'Increased Focus on Carbon Footprint Reduction', gravity: 4, urgency: 4, tendency: 5, description: 'Regulatory and consumer pressure to reduce emissions.' },
                        { name: 'Water Scarcity in Key Regions', gravity: 3, urgency: 2, tendency: 3, description: 'Potential impact on supply chains and operational sustainability.' },
                    ],
                    legal: [
                        { name: 'New Data Privacy Regulations', gravity: 5, urgency: 5, tendency: 4, description: 'Compliance requirements for handling customer data (e.g., GDPR-like laws).' },
                        { name: 'Intellectual Property Law Changes', gravity: 3, urgency: 3, tendency: 2, description: 'Updates to patent or copyright laws affecting innovation protection.' },
                    ]
                };

                // Industry-specific adjustments
                if (industry.toLowerCase().includes('technology')) {
                    baseFactors.technological.push({ name: 'Semiconductor Supply Chain Issues', gravity: 4, urgency: 5, tendency: 3, description: 'Global chip shortages affecting hardware production.' });
                    baseFactors.legal.push({ name: 'Anti-trust Scrutiny on Tech Giants', gravity: 3, urgency: 2, tendency: 4, description: 'Increased regulatory oversight for large technology companies.' });
                } else if (industry.toLowerCase().includes('healthcare')) {
                    baseFactors.political.push({ name: 'Government Healthcare Funding Policies', gravity: 5, urgency: 5, tendency: 4, description: 'Changes in public health spending and reimbursement rates.' });
                    baseFactors.social.push({ name: 'Aging Population and Chronic Diseases', gravity: 4, urgency: 4, tendency: 5, description: 'Increased demand for healthcare services due to demographic shifts.' });
                    baseFactors.technological.push({ name: 'Telemedicine Adoption', gravity: 4, urgency: 4, tendency: 5, description: 'Growth of remote patient care and digital health platforms.' });
                } else if (industry.toLowerCase().includes('finance')) {
                    baseFactors.economic.push({ name: 'Central Bank Digital Currency (CBDC) Developments', gravity: 3, urgency: 2, tendency: 4, description: 'Potential impact of government-backed digital currencies.' });
                    baseFactors.technological.push({ name: 'Rise of Decentralized Finance (DeFi)', gravity: 4, urgency: 3, tendency: 4, description: 'Emerging blockchain-based financial services challenging traditional models.' });
                }

                // Size-specific adjustments
                if (size === 'startup') {
                    baseFactors.economic.push({ name: 'Access to Venture Capital / Seed Funding', gravity: 5, urgency: 5, tendency: 3, description: 'Availability of early-stage investment critical for growth.' });
                    baseFactors.social.push({ name: 'Building Brand Awareness in a Crowded Market', gravity: 4, urgency: 4, tendency: 4, description: 'Challenges in gaining visibility against established players.' });
                } else if (size === 'large' || size === 'enterprise') {
                    baseFactors.political.push({ name: 'Navigating Complex International Regulatory Landscapes', gravity: 4, urgency: 3, tendency: 3, description: 'Compliance with diverse regulations in multiple markets.' });
                    baseFactors.legal.push({ name: 'Complex Labor Laws in Multinational Operations', gravity: 3, urgency: 3, tendency: 2, description: 'Managing employment regulations across different countries.' });
                }

                // Market-specific adjustments
                if (primaryMarket === 'australia') {
                    baseFactors.political.push({ name: 'Australian Carbon Emission Targets', gravity: 4, urgency: 4, tendency: 4, description: 'National policies on climate change impacting businesses.' });
                    baseFactors.economic.push({ name: 'Reliance on Commodity Prices (Australia)', gravity: 3, urgency: 2, tendency: 3, description: 'Impact of global commodity markets on the Australian economy.'});
                } else if (primaryMarket === 'united-states') {
                    baseFactors.political.push({ name: 'US Partisan Politics and Policy Gridlock', gravity: 3, urgency: 3, tendency: 4, description: 'Political polarization affecting legislative stability.' });
                    baseFactors.economic.push({ name: 'Federal Reserve Monetary Policy (USA)', gravity: 5, urgency: 4, tendency: 4, description: 'Impact of interest rate changes and quantitative easing/tightening.'});
                } else if (primaryMarket === 'global') {
                     baseFactors.political.push({ name: 'Geopolitical Tensions and Conflicts', gravity: 5, urgency: 5, tendency: 4, description: 'Global instability impacting supply chains and market access.' });
                }


                return {
                    political: { factors: pestelFactors.political, isCollapsed: false },
                    economic: { factors: pestelFactors.economic, isCollapsed: false },
                    social: { factors: pestelFactors.social, isCollapsed: false },
                    technological: { factors: pestelFactors.technological, isCollapsed: false },
                    environmental: { factors: pestelFactors.environmental, isCollapsed: false },
                    legal: { factors: pestelFactors.legal, isCollapsed: false }
                };
            };

            const generateCompetitors = (companyName = '', industry = '') => {
                const lowerCaseCompany = companyName.toLowerCase();
                const lowerCaseIndustry = industry.toLowerCase();
                let sampleCompetitors = [];

                if (lowerCaseCompany.includes("apple")) {
                    sampleCompetitors = ["Samsung Mobile", "Google Pixel Phones", "Huawei Devices", "Xiaomi Tech", "Oppo Gadgets", "Vivo Electronics", "OnePlus Innovations", "Sony Mobile", "LG Electronics (Mobile Div.)", "HMD Global (Nokia Phones)", "Asus Computers", "Microsoft Surface"];
                } else if (lowerCaseCompany.includes("microsoft")) {
                    sampleCompetitors = ["Google Cloud", "Amazon Web Services", "Apple Software", "Salesforce CRM", "Oracle Systems", "IBM Enterprise", "SAP Solutions", "Adobe Creative Cloud", "VMware Virtualization", "Red Hat Linux", "Cisco Networking", "Sony Gaming"];
                } else if (lowerCaseIndustry.includes("technology") || lowerCaseIndustry.includes("software")) {
                    sampleCompetitors = ["Innovatech Solutions", "Digital Future Inc.", "Cyber Systems Ltd.", "Quantum Leap AI", "NextGen Software Co.", "AlphaBeta Tech", "Synergy Softworks", "DataDrive Corp.", "CloudPioneers", "TechCore Dynamics", "LogicStream", "FutureProof Systems"];
                } else if (lowerCaseIndustry.includes("healthcare")) {
                    sampleCompetitors = ["MediCare Plus", "HealthPro Services", "WellLife Clinics", "BioGenesis Corp.", "PharmaSolutions Ltd.", "CareFirst Group", "Vitalis Health", "GenHeal Bio", "MedTech Innovators", "Elixir Pharma", "PrimeCare Network", "Wellness Partners"];
                } else if (lowerCaseIndustry.includes("finance")) {
                    sampleCompetitors = ["FinSecure Bank", "CapitalTrust Investments", "MoneyFlow Services", "Global Ledger Inc.", "WealthBuilders Co.", "CreditWise Union", "DigitalPay Solutions", "SecureFund Lenders", "Fintech Innovations Ltd.", "AssetPrime Managers", "EquityLink Capital", "PrimeMortgage Corp"];
                } else if (lowerCaseIndustry.includes("retail")) {
                     sampleCompetitors = ["ShopSmart Inc.", "Everyday Goods Co.", "RetailNext Group", "Urban Outfitters", "GlobalMart", "FashionForward Ltd.", "HomeEssentials Store", "The Gadget Hub", "QuickBuy Online", "ValueChoice Retail", "StyleSphere", "MarketFresh Foods"];
                }
                else { // Generic fallback
                    sampleCompetitors = [
                        "Global Corp Inc.", "Synergy Solutions Ltd.", "Apex Innovations Co.", "Dynamic Enterprises", "Pioneer Group",
                        "United Services", "Keystone Industries", "Starlight Ventures", "Momentum Corp.", "Quantum Systems",
                        "Vertex Group", "Orion Ltd.", "NovaTech", "Zenith Corp", "BlueSky Innovations"
                    ];
                }
                // Ensure list is around 10-15
                return sampleCompetitors.slice(0, Math.floor(Math.random() * 6) + 10); // 10 to 15
            };

            const generatePortersForces = (industry = '', primaryMarket = '') => {
                const lowerCaseIndustry = industry.toLowerCase();
                const lowerCaseMarket = primaryMarket.toLowerCase();
                
                let baseDescriptions = {
                    threatOfNewEntrants: 'Moderate - Capital requirements can be high, but digital disruption lowers barriers.',
                    bargainingPowerOfBuyers: 'High - Buyers have many choices and access to information.',
                    bargainingPowerOfSuppliers: 'Moderate - Depends on uniqueness of components/services.',
                    threatOfSubstituteProductsOrServices: 'High - Technology evolves rapidly, leading to new substitutes.',
                    rivalryAmongExistingCompetitors: 'Very High - Intense competition, frequent innovation, price wars.',
                    relativePowerOfNewComplementors: 'High - Complementary products/services (e.g., apps, accessories) enhance value.'
                };

                if (lowerCaseIndustry.includes("healthcare")) {
                    baseDescriptions.threatOfNewEntrants = 'Low - High regulatory hurdles, capital intensity, and specialized knowledge required.';
                    baseDescriptions.bargainingPowerOfBuyers = 'Moderate - Patients often rely on insurance/providers, but consumer choice is growing.';
                    baseDescriptions.bargainingPowerOfSuppliers = 'High - Specialized medical equipment and pharmaceutical suppliers have strong power.';
                    baseDescriptions.threatOfSubstituteProductsOrServices = 'Low to Moderate - Alternatives exist (e.g., preventative care vs. treatment), but direct substitutes for critical care are limited.';
                    baseDescriptions.rivalryAmongExistingCompetitors = 'Moderate to High - Competition among hospitals, clinics, and pharma companies, but often localized or specialized.';
                    baseDescriptions.relativePowerOfNewComplementors = 'Moderate - Telemedicine platforms, health tech apps, and diagnostic tools enhance services.';
                } else if (lowerCaseIndustry.includes("finance")) {
                    baseDescriptions.threatOfNewEntrants = 'Moderate to High - Fintech startups are lowering barriers, but regulatory burden remains high for traditional banking.';
                    baseDescriptions.bargainingPowerOfBuyers = 'High - Customers can easily switch banks/financial providers due to low switching costs and digital options.';
                    baseDescriptions.bargainingPowerOfSuppliers = 'Moderate - Technology providers, data services, and interbank networks hold some power.';
                    baseDescriptions.threatOfSubstituteProductsOrServices = 'High - Cryptocurrencies, peer-to-peer lending, and alternative investment platforms pose significant threats.';
                    baseDescriptions.rivalryAmongExistingCompetitors = 'Very High - Intense competition among banks, investment firms, and fintechs, often leading to aggressive marketing and product innovation.';
                    baseDescriptions.relativePowerOfNewComplementors = 'High - Payment gateways, financial planning software, and data analytics tools are crucial for modern financial services.';
                } else if (lowerCaseIndustry.includes("retail")) {
                    baseDescriptions.threatOfNewEntrants = 'High - Low barriers to entry for online retail, but physical retail requires significant capital.';
                    baseDescriptions.bargainingPowerOfBuyers = 'Very High - Consumers have vast choices, price transparency, and low switching costs.';
                    baseDescriptions.bargainingPowerOfSuppliers = 'Moderate - Large retailers have significant power, but unique brands can command higher prices.';
                    baseDescriptions.threatOfSubstituteProductsOrServices = 'High - E-commerce, direct-to-consumer brands, and sharing economy models are strong substitutes.';
                    baseDescriptions.rivalryAmongExistingCompetitors = 'Very High - Intense price competition, constant innovation in customer experience, and rapid trend changes.';
                    baseDescriptions.relativePowerOfNewComplementors = 'High - Payment solutions, logistics providers, and marketing platforms are essential for retail success.';
                }

                if (lowerCaseMarket.includes("australia")) {
                    if (lowerCaseIndustry.includes("finance")) {
                        baseDescriptions.threatOfNewEntrants += ' (Australia: Strong regulatory oversight, but fintech growth is notable).';
                        baseDescriptions.rivalryAmongExistingCompetitors += ' (Australia: Dominated by major banks, but increasing competition from smaller players).';
                    }
                } else if (lowerCaseMarket.includes("united-states")) {
                    if (lowerCaseIndustry.includes("technology")) {
                        baseDescriptions.threatOfNewEntrants += ' (USA: High innovation, but strong incumbents).';
                        baseDescriptions.rivalryAmongExistingCompetitors += ' (USA: Global tech giants lead to fierce competition).';
                    }
                }
                
                const structuredForces = {};
                for (const forceKey in baseDescriptions) {
                    structuredForces[forceKey] = {
                        description: baseDescriptions[forceKey],
                        gravity: 3, // Default G.U.T.
                        urgency: 3,
                        tendency: 3
                    };
                }
                return structuredForces;
            };

            const calculateGUTScore = (factor) => {
                return factor.gravity * factor.urgency * factor.tendency;
            };

            const getGUTScoreColor = (score) => {
                if (score >= 80) return 'gut-score-critical'; // Very high risk
                if (score >= 40) return 'gut-score-high';
                if (score >= 20) return 'gut-score-medium';
                return 'gut-score-low';
            };

            const addEnhancedFactor = (category, factorData, isProductSpecific = false, productName = '') => {
                const newFactor = {
                    name: factorData.name || '',
                    gravity: factorData.gravity || 3,
                    urgency: factorData.urgency || 3,
                    tendency: factorData.tendency || 3,
                    description: factorData.description || ''
                };

                if (isProductSpecific && productName) {
                    setProductPestels(prev => ({
                        ...prev,
                        [productName]: {
                            ...prev[productName],
                            [category]: {
                                ...prev[productName][category],
                                factors: [...prev[productName][category].factors, newFactor]
                            }
                        }
                    }));
                } else {
                    setCompanyPestelData(prev => ({
                        ...prev,
                        [category]: {
                            ...prev[category],
                            factors: [...prev[category].factors, newFactor]
                        }
                    }));
                }
            };

            const updateFactor = (category, index, updatedFactor, isProductSpecific = false, productName = '') => {
                if (isProductSpecific && productName) {
                    const updatedFactors = [...productPestels[productName][category].factors];
                    updatedFactors[index] = updatedFactor;

                    setProductPestels(prev => ({
                        ...prev,
                        [productName]: {
                            ...prev[productName],
                            [category]: {
                                ...prev[productName][category],
                                factors: updatedFactors
                            }
                        }
                    }));
                } else {
                    const updatedFactors = [...companyPestelData[category].factors];
                    updatedFactors[index] = updatedFactor;

                    setCompanyPestelData(prev => ({
                        ...prev,
                        [category]: {
                            ...prev[category],
                            factors: updatedFactors
                        }
                    }));
                }
            };

            const removeFactor = (category, index, isProductSpecific = false, productName = '') => {
                if (isProductSpecific && productName) {
                    const updatedFactors = productPestels[productName][category].factors.filter((_, i) => i !== index);
                    setProductPestels(prev => ({ ...prev, [productName]: { ...prev[productName], [category]: { ...prev[productName][category], factors: updatedFactors } } }));
                } else {
                    const updatedFactors = companyPestelData[category].factors.filter((_, i) => i !== index);
                    setCompanyPestelData(prev => ({ ...prev, [category]: { ...prev[category], factors: updatedFactors } }));
                }
            };

            const toggleCategoryCollapse = (category, isProductSpecific = false, productName = '') => {
                if (isProductSpecific && productName) {
                    setProductPestels(prev => ({
                        ...prev,
                        [productName]: {
                            ...prev[productName],
                            [category]: {
                                ...prev[productName][category],
                                isCollapsed: !prev[productName][category].isCollapsed
                            }
                        }
                    }));
                } else {
                    setCompanyPestelData(prev => ({
                        ...prev,
                        [category]: {
                            ...prev[category],
                            isCollapsed: !prev[category].isCollapsed
                        }
                    }));
                }
            };

            const calculateProductRiskScore = (productName) => {
                if (!productPestels[productName]) return 0;

                let totalScore = 0;
                let factorCount = 0;

                Object.values(productPestels[productName]).forEach(category => {
                    if (category.factors) {
                        category.factors.forEach(factor => {
                            totalScore += calculateGUTScore(factor);
                            factorCount++;
                        });
                    }
                });

                // Normalize to 0-5 scale, assuming max GUT score for one factor is 125 (5*5*5)
                // If there are 6 categories * 2 factors = 12 factors, max total score = 12 * 125 = 1500
                // So, (totalScore / 1500) * 5
                const maxPossibleScore = Object.values(productPestels[productName]).reduce((sum, cat) => sum + (cat.factors ? cat.factors.length : 0), 0) * 125;

                if (maxPossibleScore === 0) return 0; // Avoid division by zero

                return Math.round((totalScore / maxPossibleScore) * 5);
            };

            const getProductRiskLevel = (productName) => {
                const score = calculateProductRiskScore(productName);
                if (score >= 4) return { level: 'high', color: 'risk-high', label: 'High Risk' };
                if (score >= 3) return { level: 'medium-high', color: 'risk-medium', label: 'Medium Risk' }; // Using medium for 3-4 range
                if (score >= 2) return { level: 'medium', color: 'risk-medium', label: 'Medium Risk' };
                if (score >= 1) return { level: 'low', color: 'risk-low', label: 'Low Risk' };
                return { level: 'minimal', color: 'text-gray-600 bg-gray-100', label: 'No Analysis Yet' };
            };

            const renderCompanyInfo = () => {
                const getCompletionPercentage = () => {
                    const requiredFields = ['name', 'industry', 'primaryMarket', 'businessModel'];
                    const optionalFields = ['size', 'revenue', 'description', 'foundedYear', 'headquarters', 'website'];

                    const requiredCompleted = requiredFields.filter(field => companyData[field]).length;
                    const optionalCompleted = optionalFields.filter(field => companyData[field]).length;
                    const arrayFieldsCompleted = (companyData.keyProducts.length > 0 ? 1 : 0) +
                                                   (companyData.coreValues.length > 0 ? 1 : 0);

                    const totalCompleted = requiredCompleted + optionalCompleted + arrayFieldsCompleted;
                    const totalFields = requiredFields.length + optionalFields.length + 2;

                    return Math.round((totalCompleted / totalFields) * 100);
                };

                return (
                    <div className="space-y-6">
                        <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h3 className="text-xl font-bold">Company Information</h3>
                                    <p className="text-blue-100">Build your company profile for strategic analysis</p>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-bold">{getCompletionPercentage()}%</div>
                                    <div className="text-sm text-blue-100">Complete</div>
                                </div>
                            </div>
                            <div className="w-full bg-blue-400 rounded-full h-2">
                                <div
                                    className="bg-white h-2 rounded-full transition-all duration-500"
                                    style={{ width: `${getCompletionPercentage()}%` }}
                                ></div>
                            </div>
                        </div>

                        <div className="form-section">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-lg font-semibold text-gray-800">Basic Information</h4>
                                <button
                                    onClick={researchCompany}
                                    className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center gap-2"
                                    disabled={!companyData.name}
                                >
                                    <i className="fas fa-search"></i>
                                    Research Company
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div className="md:col-span-2 relative" ref={companyNameRef}>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Company Name * <span className="text-red-500">Required</span>
                                    </label>
                                    {isCompanyNameEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="text"
                                                value={companyData.name}
                                                onChange={(e) => handleCompanyNameChange(e.target.value)}
                                                onFocus={() => {
                                                    if (companyData.name.length > 0) {
                                                        const filtered = companySuggestions.filter(company =>
                                                            company.toLowerCase().includes(companyData.name.toLowerCase())
                                                        );
                                                        setFilteredCompanySuggestions(filtered);
                                                        setShowCompanySuggestions(filtered.length > 0);
                                                    }
                                                }}
                                                className="input-field flex-1"
                                                placeholder="Enter company name..."
                                                required
                                                autoFocus
                                            />
                                            <button onClick={() => setIsCompanyNameEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                            {showCompanySuggestions && filteredCompanySuggestions.length > 0 && (
                                                <div className="absolute top-full left-0 z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                                                    {filteredCompanySuggestions.slice(0, 8).map((suggestion, index) => (
                                                        <div
                                                            key={index}
                                                            onClick={() => selectCompanySuggestion(suggestion)}
                                                            className="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
                                                        >
                                                            <div className="font-medium text-gray-800">{suggestion}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.name || <span className="text-gray-400">Enter company name...</span>}
                                            </span>
                                            <button onClick={() => setIsCompanyNameEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Founded Year</label>
                                    {isFoundedYearEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="number"
                                                value={companyData.foundedYear}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, foundedYear: e.target.value }))}
                                                className="input-field flex-1"
                                                placeholder="e.g., 2010"
                                                min="1800"
                                                max={new Date().getFullYear()}
                                                autoFocus
                                            />
                                            <button onClick={() => setIsFoundedYearEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.foundedYear || <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsFoundedYearEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div ref={industryRef} className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Industry *</label>
                                    {isIndustryEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="text"
                                                value={companyData.industry}
                                                onChange={(e) => handleIndustryChange(e.target.value)}
                                                onFocus={() => {
                                                    if (companyData.industry && companyData.industry.length > 0) {
                                                        const filtered = industrySuggestions.filter(industry =>
                                                            industry.toLowerCase().includes(companyData.industry.toLowerCase())
                                                        );
                                                        setFilteredIndustrySuggestions(filtered);
                                                        setShowIndustrySuggestions(filtered.length > 0);
                                                    } else {
                                                       setShowIndustrySuggestions(true); // Show all if input is empty
                                                       setFilteredIndustrySuggestions(industrySuggestions);
                                                    }
                                                }}
                                                className="input-field flex-1"
                                                placeholder="Enter industry..."
                                                required
                                                autoFocus
                                            />
                                            <button onClick={() => setIsIndustryEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                            {showIndustrySuggestions && filteredIndustrySuggestions.length > 0 && (
                                                <div className="absolute top-full left-0 z-20 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                                                    {filteredIndustrySuggestions.slice(0, 8).map((suggestion, index) => (
                                                        <div
                                                            key={index}
                                                            onClick={() => selectIndustrySuggestion(suggestion)}
                                                            className="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
                                                        >
                                                            <div className="font-medium text-gray-800">{suggestion}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.industry || <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsIndustryEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Primary Market *</label>
                                    {isPrimaryMarketEditing ? (
                                        <div className="flex items-center">
                                            <select
                                                value={companyData.primaryMarket}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, primaryMarket: e.target.value }))}
                                                className="input-field flex-1"
                                                required
                                                autoFocus
                                            >
                                                <option value="">Select Primary Market</option>
                                                <option value="australia">Australia</option>
                                                <option value="united-states">United States</option>
                                                <option value="global">Global</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <button onClick={() => setIsPrimaryMarketEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.primaryMarket ? companyData.primaryMarket.charAt(0).toUpperCase() + companyData.primaryMarket.slice(1).replace("-", " ") : <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsPrimaryMarketEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Business Model *</label>
                                    {isBusinessModelEditing ? (
                                        <div className="flex items-center">
                                            <select
                                                value={companyData.businessModel}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, businessModel: e.target.value }))}
                                                className="input-field flex-1"
                                                required
                                                autoFocus
                                            >
                                                <option value="">Select Business Model</option>
                                                <option value="b2b">B2B (Business to Business)</option>
                                                <option value="b2c">B2C (Business to Consumer)</option>
                                                <option value="saas">SaaS (Software as a Service)</option>
                                                <option value="e-commerce">E-commerce</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <button onClick={() => setIsBusinessModelEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.businessModel ? {b2b: 'B2B', b2c: 'B2C', saas: 'SaaS', 'e-commerce': 'E-commerce', other: 'Other'}[companyData.businessModel] || companyData.businessModel : <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsBusinessModelEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Company Size</label>
                                    {isSizeEditing ? (
                                        <div className="flex items-center">
                                            <select
                                                value={companyData.size}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, size: e.target.value }))}
                                                className="input-field flex-1"
                                                autoFocus
                                            >
                                                <option value="">Select Size</option>
                                                <option value="startup">Startup (1-10 employees)</option>
                                                <option value="small">Small (11-50 employees)</option>
                                                <option value="medium">Medium (51-200 employees)</option>
                                                <option value="large">Large (201-1000 employees)</option>
                                                <option value="enterprise">Enterprise (1000+ employees)</option>
                                            </select>
                                            <button onClick={() => setIsSizeEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.size ? {startup: 'Startup (1-10)', small: 'Small (11-50)', medium: 'Medium (51-200)', large: 'Large (201-1000)', enterprise: 'Enterprise (1000+)'}[companyData.size] || companyData.size : <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsSizeEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Annual Revenue</label>
                                    {isRevenueEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="text"
                                                value={companyData.revenue}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, revenue: e.target.value }))}
                                                className="input-field flex-1"
                                                placeholder="e.g., \$10M, \$100M, \$1B"
                                                autoFocus
                                            />
                                            <button onClick={() => setIsRevenueEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.revenue || <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsRevenueEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Headquarters</label>
                                    {isHeadquartersEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="text"
                                                value={companyData.headquarters}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, headquarters: e.target.value }))}
                                                className="input-field flex-1"
                                                placeholder="City, Country"
                                                autoFocus
                                            />
                                            <button onClick={() => setIsHeadquartersEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.headquarters || <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsHeadquartersEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                    {isWebsiteEditing ? (
                                        <div className="flex items-center">
                                            <input
                                                type="url"
                                                value={companyData.website}
                                                onChange={(e) => setCompanyData(prev => ({ ...prev, website: e.target.value }))}
                                                className="input-field flex-1"
                                                placeholder="https://www.company.com"
                                                autoFocus
                                            />
                                            <button onClick={() => setIsWebsiteEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                <i className="fas fa-check"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center">
                                            <span className="input-field flex-1 min-h-[40px] flex items-center">
                                                {companyData.website || <span className="text-gray-400">N/A</span>}
                                            </span>
                                            <button onClick={() => setIsWebsiteEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="mt-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Company Description</label>
                                {isDescriptionEditing ? (
                                    <div className="flex items-start"> {/* items-start for textarea alignment */}
                                        <textarea
                                            value={companyData.description}
                                            onChange={(e) => setCompanyData(prev => ({ ...prev, description: e.target.value }))}
                                            className="input-field flex-1"
                                            rows="4"
                                            placeholder="Brief description of your company's business model, main activities, and market position..."
                                            autoFocus
                                        />
                                        <button onClick={() => setIsDescriptionEditing(false)} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                            <i className="fas fa-check"></i>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex items-start">
                                        <span className="input-field flex-1 min-h-[88px] flex items-center whitespace-pre-wrap"> {/* Adjusted min-h and whitespace */}
                                            {companyData.description || <span className="text-gray-400">Not set</span>}
                                        </span>
                                        <button onClick={() => setIsDescriptionEditing(true)} className="ml-2 p-2 text-blue-600 hover:text-blue-800">
                                            <i className="fas fa-edit"></i>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="form-section">
                            <h4 className="text-lg font-semibold text-gray-800 mb-4">Products & Services</h4>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Key Products/Services</label>
                                <div className="space-y-2">
                                    {companyData.keyProducts.map((product, index) => (
                                        <div key={index} className="flex items-center gap-2">
                                            <span className="flex-1 p-2 bg-gray-50 rounded border">{product}</span>
                                            <button
                                                onClick={() => removeArrayItem(setCompanyData, companyData.keyProducts, index, 'keyProducts')}
                                                className="text-red-500 hover:text-red-700 p-2"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    ))}
                                    <input
                                        type="text"
                                        placeholder="Add product or service..."
                                        className="input-field"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                addArrayItem(setCompanyData, companyData.keyProducts, e.target.value, 'keyProducts');
                                                e.target.value = '';
                                            }
                                        }}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h4 className="text-lg font-semibold text-gray-800 mb-4">Mission, Vision & Values</h4>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Mission Statement</label>
                                    <textarea
                                        value={companyData.missionStatement}
                                        onChange={(e) => setCompanyData(prev => ({ ...prev, missionStatement: e.target.value }))}
                                        className="input-field"
                                        rows="3"
                                        placeholder="What is your company's purpose and primary objectives?"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Vision Statement</label>
                                    <textarea
                                        value={companyData.visionStatement}
                                        onChange={(e) => setCompanyData(prev => ({ ...prev, visionStatement: e.target.value }))}
                                        className="input-field"
                                        rows="3"
                                        placeholder="What does your company aspire to become in the future?"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Core Values</label>
                                    <div className="space-y-2">
                                        {companyData.coreValues.map((value, index) => (
                                            <div key={index} className="flex items-center gap-2">
                                                <span className="flex-1 p-2 bg-gray-50 rounded border">{value}</span>
                                                <button
                                                    onClick={() => removeArrayItem(setCompanyData, companyData.coreValues, index, 'coreValues')}
                                                    className="text-red-500 hover:text-red-700 p-2"
                                                >
                                                    <i className="fas fa-times"></i>
                                                </button>
                                            </div>
                                        ))}
                                        <input
                                            type="text"
                                            placeholder="Add core value..."
                                            className="input-field"
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter') {
                                                    addArrayItem(setCompanyData, companyData.coreValues, e.target.value, 'coreValues');
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h4 className="text-lg font-semibold text-gray-800 mb-4">Leadership</h4>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Key Executives</label>
                                <div className="space-y-2">
                                    {companyData.keyExecutives.map((executive, index) => (
                                        <div key={index} className="flex items-center gap-2">
                                            <span className="flex-1 p-2 bg-gray-50 rounded border text-sm">{executive}</span>
                                            <button
                                                onClick={() => removeArrayItem(setCompanyData, companyData.keyExecutives, index, 'keyExecutives')}
                                                className="text-red-500 hover:text-red-700 p-2"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    ))}
                                    <input
                                        type="text"
                                        placeholder="Add executive (Name - Title)..."
                                        className="input-field"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                addArrayItem(setCompanyData, companyData.keyExecutives, e.target.value, 'keyExecutives');
                                                e.target.value = '';
                                            }
                                        }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderPestelAnalysis = () => {
                const currentPestelData = selectedPestelScope === 'company' ? companyPestelData : productPestels[selectedPestelScope];
                const isProductSpecificView = selectedPestelScope !== 'company';

            const toggleFactorFieldEdit = (factorKey, field) => {
                setFactorFieldEditStates(prev => ({
                    ...prev,
                    [`${factorKey}-${field}`]: !prev[`${factorKey}-${field}`]
                }));
            };

            const isFactorFieldEditing = (factorKey, field) => {
                return !!factorFieldEditStates[`${factorKey}-${field}`];
            };

            const isPortersDescriptionEditing = (scope, forceKey) => {
                return !!portersDescriptionEditStates[`${scope}-${forceKey}`];
            };

            const togglePortersDescriptionEdit = (scope, forceKey) => {
                setPortersDescriptionEditStates(prev => ({
                    ...prev,
                    [`${scope}-${forceKey}`]: !prev[`${scope}-${forceKey}`]
                }));
            };

            const generateSampleClientPersonas = (count = 3, companyIndustry = "General", productName = null) => {
                const samplePersonas = [];
                const occupations = ["Marketing Manager", "Software Engineer", "Small Business Owner", "Teacher", "Doctor", "Student", "Artist", "Project Manager"];
                const personaNames = ["Alex", "Jamie", "Chris", "Pat", "Sam", "Taylor", "Jordan", "Morgan"];
                const adjectives = ["Driven", "Tech-Savvy", "Busy", "Creative", "Pragmatic", "Budget-Conscious", "Organized", "Detail-Oriented"];

                for (let i = 0; i < count; i++) {
                    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                    const name = personaNames[Math.floor(Math.random() * personaNames.length)];
                    const occupation = occupations[Math.floor(Math.random() * occupations.length)];
                    const age = Math.floor(Math.random() * 40) + 22; // Age between 22 and 62

                    let goals = [
                        `Achieve ${Math.random() > 0.5 ? 'better work-life balance' : 'career growth'}`,
                        `Find ${Math.random() > 0.5 ? 'user-friendly tools' : 'cost-effective solutions'}`,
                        `Improve ${Math.random() > 0.5 ? 'productivity' : 'collaboration with team'}`
                    ];
                    let frustrations = [
                        `Dealing with ${Math.random() > 0.5 ? 'complex software' : 'poor customer service'}`,
                        `Wasting time on ${Math.random() > 0.5 ? 'manual tasks' : 'inefficient processes'}`,
                        `${Math.random() > 0.5 ? 'High learning curve' : 'Lack of integration'} for new tools`
                    ];

                    if (companyIndustry.toLowerCase().includes("healthcare")) {
                        goals.push("Access reliable patient information quickly");
                        frustrations.push("Navigating complex medical billing");
                    } else if (companyIndustry.toLowerCase().includes("technology")) {
                        goals.push("Stay updated with the latest tech trends");
                        frustrations.push("Data security concerns");
                    }
                     if (productName) {
                        goals.push(`Find a solution specifically for ${productName}`);
                    }


                    samplePersonas.push({
                        id: `persona-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: `${adj} ${name}`,
                        age: age,
                        occupation: occupation,
                        bio: `A ${adj.toLowerCase()} ${occupation.toLowerCase()} aged ${age}, looking for ways to streamline their work and achieve key objectives in the ${companyIndustry} sector. ${productName ? `Specifically interested in solutions related to ${productName}.` : ''}`,
                        goals: goals,
                        frustrations: frustrations,
                        gravity: Math.floor(Math.random() * 3) + 3, // 3-5
                        urgency: Math.floor(Math.random() * 3) + 3, // 3-5
                        tendency: Math.floor(Math.random() * 3) + 3, // 3-5
                    });
                }
                return samplePersonas;
            }

                const renderPestelFactors = (pestelData, isProductSpecific = false, productName = '') => {
                    return Object.entries(pestelData).map(([category, data]) => (
                    <div key={`${productName || 'company'}-${category}`} className="mb-6 border border-gray-200 rounded-lg">
                            <div
                                className="collapsible-header"
                                onClick={() => toggleCategoryCollapse(category, isProductSpecific, productName)}
                            >
                                <h4 className="font-semibold text-gray-800 capitalize">{category} Factors</h4>
                                <div className="flex items-center gap-2">
                                    <span className="text-sm text-gray-600">
                                        {data.factors.length} factor{data.factors.length !== 1 ? 's' : ''}
                                    </span>
                                    <i className={`fas ${data.isCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'}`}></i>
                                </div>
                            </div>

                            <div className={`collapsible-content ${data.isCollapsed ? '' : 'open'}`}>
                                <div className="collapsible-content-inner">
                                    <div className="mb-4">
                                        <button
                                            onClick={() => addEnhancedFactor(category, { name: `New ${category} factor` }, isProductSpecific, productName)}
                                            className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                                        >
                                            <i className="fas fa-plus mr-1"></i>Add Factor
                                        </button>
                                    </div>

                                <div className="space-y-4">
                                        {data.factors.map((factor, index) => {
                                            const gutScore = calculateGUTScore(factor);
                                        const factorKey = `${productName || 'company'}-${category}-${index}`;
                                        const isNameEditing = isFactorFieldEditing(factorKey, 'name');
                                        const isDescriptionEditing = isFactorFieldEditing(factorKey, 'description');

                                            return (
                                            <div key={factorKey} className="border border-gray-200 rounded p-4 space-y-3 bg-white shadow-sm">
                                                {/* Factor Name */}
                                                <div className="flex justify-between items-center">
                                                    {isNameEditing ? (
                                                        <div className="flex-grow flex items-center">
                                                            <input
                                                                type="text"
                                                                value={factor.name}
                                                                onChange={(e) => updateFactor(category, index, { ...factor, name: e.target.value }, isProductSpecific, productName)}
                                                                className="input-field text-sm flex-grow"
                                                                placeholder="Factor name..."
                                                                autoFocus
                                                            />
                                                            <button onClick={() => toggleFactorFieldEdit(factorKey, 'name')} className="ml-2 p-2 text-green-600 hover:text-green-800">
                                                                <i className="fas fa-check"></i>
                                                            </button>
                                                            </div>
                                                    ) : (
                                                        <div className="flex-grow flex items-center">
                                                            <h6 className="font-medium text-gray-800 flex-grow cursor-pointer" onClick={() => toggleFactorFieldEdit(factorKey, 'name')}>{factor.name || "Unnamed Factor"}</h6>
                                                            <button onClick={() => toggleFactorFieldEdit(factorKey, 'name')} className="ml-2 p-1 text-blue-500 hover:text-blue-700 text-xs">
                                                                <i className="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    )}
                                                    <div className="flex items-center gap-2 ml-4">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold ${getGUTScoreColor(gutScore)}`}>
                                                            G.U.T: {gutScore}
                                                        </span>
                                                        <button
                                                            onClick={() => removeFactor(category, index, isProductSpecific, productName)}
                                                            className="text-red-500 hover:text-red-700 text-sm"
                                                            title="Remove factor"
                                                        >
                                                            <i className="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* Factor Description */}
                                                <div>
                                                    {isDescriptionEditing ? (
                                                        <div className="flex items-start">
                                                            <textarea
                                                                value={factor.description}
                                                                onChange={(e) => updateFactor(category, index, { ...factor, description: e.target.value }, isProductSpecific, productName)}
                                                                className="input-field text-sm flex-grow"
                                                                rows="3"
                                                                placeholder="Detailed description..."
                                                                autoFocus
                                                            ></textarea>
                                                            <button onClick={() => toggleFactorFieldEdit(factorKey, 'description')} className="ml-2 p-2 text-green-600 hover:text-green-800 self-start">
                                                                <i className="fas fa-check"></i>
                                                                </button>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-start">
                                                            <p className="text-sm text-gray-600 mb-0 flex-grow cursor-pointer whitespace-pre-wrap min-h-[20px]" onClick={() => toggleFactorFieldEdit(factorKey, 'description')}>
                                                                {factor.description || <span className="text-gray-400">No description. Click to add.</span>}
                                                            </p>
                                                            <button onClick={() => toggleFactorFieldEdit(factorKey, 'description')} className="ml-2 p-1 text-blue-500 hover:text-blue-700 text-xs self-start">
                                                                <i className="fas fa-edit"></i>
                                                                </button>
                                                            </div>
                                                    )}
                                                </div>

                                                {/* G.U.T. Scores - Always Selectable */}
                                                <div className="grid grid-cols-3 gap-3 pt-2 border-t border-gray-100">
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-500 mb-1">Gravity (1-5)</label>
                                                        <select
                                                            value={factor.gravity}
                                                            onChange={(e) => updateFactor(category, index, { ...factor, gravity: parseInt(e.target.value) }, isProductSpecific, productName)}
                                                            className="input-field text-sm py-1"
                                                        >
                                                            {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>{n}</option>)}
                                                        </select>
                                                        </div>
                                                        <div>
                                                        <label className="block text-xs font-medium text-gray-500 mb-1">Urgency (1-5)</label>
                                                        <select
                                                            value={factor.urgency}
                                                            onChange={(e) => updateFactor(category, index, { ...factor, urgency: parseInt(e.target.value) }, isProductSpecific, productName)}
                                                            className="input-field text-sm py-1"
                                                        >
                                                            {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>{n}</option>)}
                                                        </select>
                                                        </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-500 mb-1">Tendency (1-5)</label>
                                                        <select
                                                            value={factor.tendency}
                                                            onChange={(e) => updateFactor(category, index, { ...factor, tendency: parseInt(e.target.value) }, isProductSpecific, productName)}
                                                            className="input-field text-sm py-1"
                                                        >
                                                            {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>{n}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ));
                };

                return (
                    <div className="space-y-6">
                        <div className="form-section">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800">PESTEL Analysis</h3>
                                    <p className="text-gray-600">Analyze external macro-environmental factors using G.U.T scoring</p>
                                </div>
                                <div className="flex gap-2 items-center">
                                    <label htmlFor="pestel-scope-select" className="text-sm font-medium text-gray-700">View:</label>
                                    <select
                                        id="pestel-scope-select"
                                        value={selectedPestelScope}
                                        onChange={(e) => setSelectedPestelScope(e.target.value)}
                                        className="input-field text-sm"
                                    >
                                        <option value="company">Company PESTEL</option>
                                        {companyData.keyProducts.map((product, index) => (
                                            <option key={index} value={product}>{product} PESTEL</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={() => {
                                            const newPestelData = generateCompanyPestelData(companyData.name, companyData.industry, companyData.size, companyData.primaryMarket);
                                            setCompanyPestelData(newPestelData);
                                            // Optionally, if the user is viewing the company PESTEL, make sure it's not collapsed
                                            if (selectedPestelScope === 'company') {
                                                const uncollapsedData = {};
                                                for (const category in newPestelData) {
                                                    uncollapsedData[category] = { ...newPestelData[category], isCollapsed: false };
                                                }
                                                setCompanyPestelData(uncollapsedData);
                                            }
                                            alert('Sample company-wide PESTEL factors generated. You can review and adapt them as needed.');
                                        }}
                                        className="button-secondary text-sm flex items-center gap-2"
                                        title="Generates a new set of sample PESTEL factors for the entire company based on its current profile. This will overwrite existing company PESTEL data."
                                    >
                                        <i className="fas fa-wand-magic-sparkles"></i>
                                        Suggest Company PESTEL Factors
                                    </button>
                                </div>
                            </div>

                            {companyData.keyProducts.length === 0 && selectedPestelScope !== 'company' && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                                    <div className="flex">
                                        <i className="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                                        <div>
                                            <h4 className="text-sm font-medium text-yellow-800">No Products Added</h4>
                                            <p className="text-sm text-yellow-700 mt-1">
                                                Add products in the Company Info section to enable product-specific PESTEL analysis.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {selectedPestelScope === 'company' ? (
                            <div className="form-section">
                                <div className="mb-4">
                                    <h4 className="text-lg font-semibold text-gray-800 mb-2">Company-Wide PESTEL Analysis</h4>
                                    <p className="text-gray-600 text-sm">
                                        Analyze macro-environmental factors that affect your entire company across all products and services.
                                    </p>
                                </div>
                                {renderPestelFactors(companyPestelData)}
                            </div>
                        ) : (
                            <div className="form-section">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h4 className="text-lg font-semibold text-gray-800">{selectedPestelScope}</h4>
                                        <p className="text-gray-600">Product-Specific PESTEL Analysis</p>
                                    </div>
                                    <div className="text-right">
                                        <div className={`inline-block px-3 py-1 rounded text-sm font-bold ${getProductRiskLevel(selectedPestelScope).color}`}>
                                            {getProductRiskLevel(selectedPestelScope).label}
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            Risk Score: {calculateProductRiskScore(selectedPestelScope)}/5
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h5 className="font-semibold text-blue-800 mb-2">
                                        <i className="fas fa-lightbulb mr-2"></i>
                                        Analysis Guidance
                                    </h5>
                                    <p className="text-sm text-blue-700">
                                        Focus on factors that specifically impact <strong>{selectedPestelScope}</strong>.
                                        Consider how each environmental factor affects this product's development, marketing,
                                        distribution, and customer adoption differently from your other products.
                                    </p>
                                </div>

                                {productPestels[selectedPestelScope] ? (
                                    renderPestelFactors(productPestels[selectedPestelScope], true, selectedPestelScope)
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        <i className="fas fa-spinner fa-spin text-2xl mb-4"></i>
                                        <p>Loading product PESTEL data...</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const renderPortersSixForces = () => {
                return (
                    <div className="space-y-6">
                        <div className="form-section">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Porter's Six Forces Analysis</h3>
                            <p className="text-gray-600 mb-6">
                                Analyze the competitive intensity and attractiveness of your industry. Adjust descriptions and G.U.T. scores as needed.
                            </p>
                            
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex gap-2 items-center">
                                    <label htmlFor="porters-scope-select" className="text-sm font-medium text-gray-700">Analysis Scope:</label>
                                    <select
                                        id="porters-scope-select"
                                        value={selectedPortersScope}
                                        onChange={(e) => setSelectedPortersScope(e.target.value)}
                                        className="input-field text-sm w-auto"
                                    >
                                        <option value="company">Company Porter's Forces</option>
                                        {companyData.keyProducts.map((product, index) => (
                                            <option key={index} value={product}>{product} Porter's Forces</option>
                                        ))}
                                    </select>
                                </div>
                                <button
                                    onClick={() => {
                                        const suggestedForces = generatePortersForces(companyData.industry, companyData.primaryMarket);
                                        if (selectedPortersScope === 'company') {
                                            setPortersForces(suggestedForces);
                                        } else {
                                            setProductPortersForces(prev => ({
                                                ...prev,
                                                [selectedPortersScope]: suggestedForces
                                            }));
                                        }
                                        alert(`Suggested Porter's forces for "${selectedPortersScope === 'company' ? 'the company' : selectedPortersScope}" have been applied.`);
                                    }}
                                    className="button-secondary text-sm flex items-center gap-2"
                                    title={`Generate and apply suggested Porter's forces for the ${selectedPortersScope === 'company' ? 'company' : selectedPortersScope}. This will overwrite current data for this scope.`}
                                >
                                    <i className="fas fa-wand-magic-sparkles"></i>
                                    Suggest Forces for {selectedPortersScope === 'company' ? 'Company' : selectedPortersScope}
                                </button>
                            </div>


                            {(!companyData.industry && !companyData.primaryMarket && selectedPortersScope === 'company') && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                                    <div className="flex">
                                        <i className="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                                        <div>
                                            <h4 className="text-sm font-medium text-yellow-800">Missing Information for Auto-Population</h4>
                                            <p className="text-sm text-yellow-700 mt-1">
                                                Fill in "Industry" and "Primary Market" in Company Info for tailored company-level suggestions. You can still edit manually.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {Object.entries(selectedPortersScope === 'company' ? portersForces : (productPortersForces[selectedPortersScope] || portersForces) ).map(([forceKey, forceData]) => {
                                const gutScore = calculateGUTScore(forceData);
                                const isDescriptionEditingCurrent = isPortersDescriptionEditing(selectedPortersScope, forceKey);

                                const handleForceChange = (field, value) => {
                                    const scopeToUpdate = selectedPortersScope;
                                    if (scopeToUpdate === 'company') {
                                        setPortersForces(prev => ({
                                            ...prev,
                                            [forceKey]: {
                                                ...prev[forceKey],
                                                [field]: field === 'description' ? value : parseInt(value)
                                            }
                                        }));
                                    } else {
                                        setProductPortersForces(prev => ({
                                            ...prev,
                                            [scopeToUpdate]: {
                                                ...prev[scopeToUpdate],
                                                [forceKey]: {
                                                    ...(prev[scopeToUpdate] ? prev[scopeToUpdate][forceKey] : {}),
                                                    [field]: field === 'description' ? value : parseInt(value)
                                                }
                                            }
                                        }));
                                    }
                                };

                                return (
                                    <div key={`${selectedPortersScope}-${forceKey}`} className="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-md font-semibold text-gray-700 capitalize">
                                                {forceKey.replace(/([A-Z])/g, ' \$1').replace('Of', 'of ').replace('Or', 'or ')}
                                            </label>
                                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${getGUTScoreColor(gutScore)}`}>
                                                G.U.T: {gutScore}
                                            </span>
                                        </div>

                                        {isDescriptionEditingCurrent ? (
                                            <div className="flex items-start">
                                                <textarea
                                                    value={forceData.description}
                                                    onChange={(e) => handleForceChange('description', e.target.value)}
                                                    className="input-field mb-3 flex-grow"
                                                    rows="4"
                                                    placeholder={`Detailed analysis for ${forceKey.replace(/([A-Z])/g, ' \$1').toLowerCase()}...`}
                                                    autoFocus
                                                ></textarea>
                                                <button onClick={() => togglePortersDescriptionEdit(selectedPortersScope, forceKey)} className="ml-2 p-2 text-green-600 hover:text-green-800 self-start">
                                                    <i className="fas fa-check"></i>
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="flex items-start">
                                                <div 
                                                    className="input-field mb-3 flex-grow min-h-[88px] whitespace-pre-wrap cursor-pointer" 
                                                    onClick={() => togglePortersDescriptionEdit(selectedPortersScope, forceKey)}
                                                >
                                                    {forceData.description || <span className="text-gray-400">No description. Click to edit.</span>}
                                                </div>
                                                <button onClick={() => togglePortersDescriptionEdit(selectedPortersScope, forceKey)} className="ml-2 p-1 text-blue-500 hover:text-blue-700 text-xs self-start">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-3 gap-3 mt-2">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-500 mb-1">Gravity (1-5)</label>
                                                <select
                                                    value={forceData.gravity}
                                                    onChange={(e) => handleForceChange('gravity', e.target.value)}
                                                    className="input-field text-sm py-1"
                                                >
                                                    {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-500 mb-1">Urgency (1-5)</label>
                                                <select
                                                    value={forceData.urgency}
                                                    onChange={(e) => handleForceChange('urgency', e.target.value)}
                                                    className="input-field text-sm py-1"
                                                >
                                                    {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-500 mb-1">Tendency (1-5)</label>
                                                <select
                                                    value={forceData.tendency}
                                                    onChange={(e) => handleForceChange('tendency', e.target.value)}
                                                    className="input-field text-sm py-1"
                                                >
                                                    {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            // New reusable function for editable lists
            const renderEditableCompetitorListUI = (list, setList, listNameSingular, listNamePlural, placeholderText = `Enter ${listNameSingular.toLowerCase()} name...`) => {
                const [newItem, setNewItem] = useState('');

                const addItem = () => {
                    if (newItem.trim() && !list.includes(newItem.trim())) {
                        setList(prev => [...prev, newItem.trim()]);
                        setNewItem('');
                    } else if (list.includes(newItem.trim())) {
                        alert(`${listNameSingular} "${newItem.trim()}" is already in the list.`);
                    }
                };

                const removeItem = (index) => {
                    setList(prev => prev.filter((_, i) => i !== index));
                };

                return (
                    <div className="form-section">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Identified {listNamePlural}</h3>
                        <div className="space-y-2 mb-4">
                            {list.length === 0 && (
                                <p className="text-gray-500 text-sm">No {listNamePlural.toLowerCase()} identified yet. You can add them manually below or use suggestion features if available for this section.</p>
                            )}
                            {list.map((item, index) => (
                                <div key={`${listNameSingular}-${index}`} className="flex items-center justify-between gap-2 bg-gray-50 p-2 rounded border">
                                    <span className="flex-1 text-gray-800 text-sm">{item}</span>
                                    <button
                                        onClick={() => removeItem(index)}
                                        className="text-red-500 hover:text-red-700 p-1 text-xs"
                                        title={`Remove ${listNameSingular}`}
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Add New {listNameSingular} Manually</label>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={newItem}
                                    onChange={(e) => setNewItem(e.target.value)}
                                    className="input-field flex-1"
                                    placeholder={placeholderText}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            addItem();
                                        }
                                    }}
                                />
                                <button onClick={addItem} className="button-primary px-4 py-2 text-sm">
                                    Add {listNameSingular}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderInternalIssuesTab_TemporaryCompetitors = () => {
                return (
                    <div className="space-y-6">
                        <div className="form-section">
                             <h3 className="text-lg font-semibold text-gray-800 mb-4">Internal Issues - Competitor List</h3>
                             <p className="text-gray-600 mb-6">
                                Identify key competitors related to internal issues or specific operational aspects. This list is separate from the main "Competitors Analysis" tab.
                            </p>
                            <button
                                onClick={() => {
                                    const sample = generateCompetitors(companyData.name, companyData.industry);
                                    setCompetitors(sample);
                                    alert('Sample competitors for Internal Issues generated!');
                                }}
                                className="button-secondary mb-4" // Using secondary to differentiate
                            >
                                Suggest Sample Competitors (for Internal Issues)
                            </button>
                            {renderEditableCompetitorListUI(
                                competitors,
                                setCompetitors,
                                "Competitor (Internal Issues)",
                                "Competitors (Internal Issues)",
                                "Enter competitor name for internal issues..."
                            )}
                        </div>
                         {/* Placeholder for other internal issues content */}
                         <div className="form-section bg-gray-50">
                            <h4 className="text-md font-semibold text-gray-700">Other Internal Analysis Tools (Coming Soon)</h4>
                            <p className="text-sm text-gray-500">Tools for analyzing other internal issues will be available here.</p>
                         </div>
                    </div>
                );
            };
            
            const renderCompetitorsAnalysisTab = () => {
                return (
                    <div className="space-y-6">
                        <div className="form-section">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Competitors Analysis</h3>
                            <p className="text-gray-600 mb-6">
                                Identify and analyze your key market competitors. Use the button below to generate a sample list based on company information.
                            </p>
                            <button
                                onClick={() => {
                                    const sample = generateCompetitors(companyData.name, companyData.industry);
                                    setNewCompetitorsList(sample);
                                    alert('Sample market competitors generated!');
                                }}
                                className="button-primary mb-4"
                            >
                                Suggest Sample Market Competitors
                            </button>
                            {renderEditableCompetitorListUI(
                                newCompetitorsList,
                                setNewCompetitorsList,
                                "Market Competitor",
                                "Market Competitors",
                                "Enter market competitor name..."
                            )}
                        </div>
                        {/* Placeholder for detailed analysis of each competitor in newCompetitorsList */}
                        <div className="form-section bg-gray-50">
                            <h4 className="text-md font-semibold text-gray-700">Detailed Competitor Breakdown (Coming Soon)</h4>
                            <p className="text-sm text-gray-500">Tools for detailed analysis of each market competitor will appear here.</p>
                        </div>
                    </div>
                );
            };

            const renderOtherPhases = () => (
                <div className="tab-content">
                    <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4" role="alert">
                        <p className="font-bold">Coming Soon!</p>
                        <p>This section will be implemented in future updates.</p>
                    </div>
                </div>
            );

            const renderCompetitorsAnalysisTab = () => {
                return (
                    <div className="tab-content">
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                            <p className="font-bold">Competitors Analysis</p>
                            <p>Content for this section will be implemented soon.</p>
                        </div>
                    </div>
                );
            };

            const renderClientsPersonasTab = () => {
                const currentPersonas = selectedPersonaScope === 'company' ? companyPersonas : (productPersonas[selectedPersonaScope] || []);

                const handleSuggestPersonas = () => {
                    const newPersonas = generateSampleClientPersonas(3, companyData.industry, selectedPersonaScope === 'company' ? null : selectedPersonaScope);
                    if (selectedPersonaScope === 'company') {
                        setCompanyPersonas(newPersonas);
                    } else {
                        setProductPersonas(prev => ({
                            ...prev,
                            [selectedPersonaScope]: newPersonas
                        }));
                    }
                    alert(`Generated ${newPersonas.length} sample personas for ${selectedPersonaScope === 'company' ? 'the company' : selectedPersonaScope}.`);
                };

                const handleAddNewPersona = () => {
                    const newPersona = {
                        id: `persona-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: "New Persona",
                        age: 30,
                        occupation: "Occupation",
                        bio: "Bio - describe persona here.",
                        goals: ["Goal 1", "Goal 2"],
                        frustrations: ["Frustration 1", "Frustration 2"],
                        gravity: 3,
                        urgency: 3,
                        tendency: 3,
                    };
                    if (selectedPersonaScope === 'company') {
                        setCompanyPersonas(prev => [...prev, newPersona]);
                    } else {
                        setProductPersonas(prev => ({
                            ...prev,
                            [selectedPersonaScope]: [...(prev[selectedPersonaScope] || []), newPersona]
                        }));
                    }
                };

                const handleRemovePersona = (personaIdToRemove) => {
                    if (selectedPersonaScope === 'company') {
                        setCompanyPersonas(prev => prev.filter(p => p.id !== personaIdToRemove));
                    } else {
                        setProductPersonas(prev => ({
                            ...prev,
                            [selectedPersonaScope]: (prev[selectedPersonaScope] || []).filter(p => p.id !== personaIdToRemove)
                        }));
                    }
                };


                return (
                    <div className="space-y-6">
                        <div className="form-section">
                            <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800">Client Personas</h3>
                                    <p className="text-gray-600">Define and manage client personas for company or specific products.</p>
                                </div>
                            </div>
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex gap-2 items-center">
                                    <label htmlFor="persona-scope-select" className="text-sm font-medium text-gray-700">Analysis Scope:</label>
                                    <select
                                        id="persona-scope-select"
                                        value={selectedPersonaScope}
                                        onChange={(e) => setSelectedPersonaScope(e.target.value)}
                                        className="input-field text-sm w-auto"
                                    >
                                        <option value="company">Company-Wide Personas</option>
                                        {companyData.keyProducts.map((product, index) => (
                                            <option key={index} value={product}>{product} Personas</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={handleSuggestPersonas}
                                        className="button-secondary text-sm flex items-center gap-2"
                                        title={`Generate sample personas for ${selectedPersonaScope === 'company' ? 'the company' : selectedPersonaScope}. This will overwrite current personas for this scope.`}
                                    >
                                        <i className="fas fa-wand-magic-sparkles"></i>
                                        Suggest Personas
                                    </button>
                                    <button
                                        onClick={handleAddNewPersona}
                                        className="button-primary text-sm flex items-center gap-2"
                                        title={`Add a new blank persona to the ${selectedPersonaScope === 'company' ? 'company' : selectedPersonaScope} scope.`}
                                    >
                                        <i className="fas fa-plus"></i>
                                        Add New Persona
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h4 className="text-md font-semibold text-gray-700 mb-4">
                                Personas for: {selectedPersonaScope === 'company' ? 'Company-Wide' : selectedPersonaScope} ({currentPersonas.length})
                            </h4>
                            {currentPersonas.length === 0 ? (
                                <p className="text-gray-500 p-4 text-center">No personas defined for this scope. Click "Suggest Personas" or "Add New Persona".</p>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {currentPersonas.map(persona => (
                                        <div key={persona.id} className="border p-4 rounded-lg shadow-lg bg-white hover:shadow-xl transition-shadow duration-200">
                                            <div className="flex justify-between items-start mb-2">
                                                <h5 className="text-lg font-bold text-blue-700">{persona.name}</h5>
                                                <button 
                                                    onClick={() => handleRemovePersona(persona.id)}
                                                    className="text-red-400 hover:text-red-600 p-1"
                                                    title="Remove Persona"
                                                >
                                                    <i className="fas fa-times-circle"></i>
                                                </button>
                                            </div>
                                            <p className="text-xs text-gray-500 mb-2">{persona.occupation}, Age: {persona.age}</p>
                                            
                                            <div className="mb-3">
                                                <h6 className="text-xs font-semibold text-gray-600 mb-1">Bio:</h6>
                                                <p className="text-sm text-gray-700 whitespace-pre-wrap">{persona.bio}</p>
                                            </div>
                                            
                                            <div className="mb-3">
                                                <h6 className="text-xs font-semibold text-gray-600 mb-1">Goals:</h6>
                                                <ul className="list-disc list-inside text-sm text-gray-700">
                                                    {persona.goals.map((goal, i) => <li key={i}>{goal}</li>)}
                                                </ul>
                                            </div>
                                            
                                            <div className="mb-3">
                                                <h6 className="text-xs font-semibold text-gray-600 mb-1">Frustrations:</h6>
                                                <ul className="list-disc list-inside text-sm text-gray-700">
                                                    {persona.frustrations.map((frustration, i) => <li key={i}>{frustration}</li>)}
                                                </ul>
                                            </div>
                                            
                                            <div className="border-t pt-3 mt-3">
                                                <h6 className="text-xs font-semibold text-gray-600 mb-1">G.U.T. Scores:</h6>
                                                <div className="flex justify-between items-center text-sm">
                                                    <span className="text-gray-700">G: {persona.gravity}</span>
                                                    <span className="text-gray-700">U: {persona.urgency}</span>
                                                    <span className="text-gray-700">T: {persona.tendency}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${getGUTScoreColor(calculateGUTScore(persona))}`}>
                                                        Total: {calculateGUTScore(persona)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                             <p className="text-center text-gray-400 mt-8 text-sm">Editing individual persona fields will be implemented in a future step.</p>
                        </div>
                    </div>
                );
            };

            const renderCurrentPhase = () => {
                switch (currentPhase) {
                    case 'company-info':
                        return renderCompanyInfo();
                    case 'pestel':
                        return renderPestelAnalysis();
                    case 'porter':
                        return renderPortersSixForces();
                    case 'competitor': // This is the "Internal Issues" tab
                        return renderInternalIssuesTab_TemporaryCompetitors();
                    case 'competitors-analysis': // This is the new "Competitors Analysis" tab
                        return renderCompetitorsAnalysisTab();
                    case 'clients-personas':
                        return renderClientsPersonasTab();
                    default:
                        return renderOtherPhases();
                }
            };

            return (
                <div className="strategic-planning-suite">
                    <div className="header">
                        <h1 className="text-2xl font-bold">Strategic Planning Suite</h1>
                    </div>
                    <div className="nav-tabs">
                        {phases.map((phase) => (
                            <button
                                key={phase.id}
                                onClick={() => setCurrentPhase(phase.id)}
                                className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                                    currentPhase === phase.id ? 'bg-blue-600 text-white' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'
                                }`}
                            >
                                <i className={`${phase.icon} mr-2`}></i>
                                {phase.name}
                            </button>
                        ))}
                    </div>
                    <div className="tab-content">
                        {renderCurrentPhase()}
                    </div>
                </div>
            );
        }

        try {
            ReactDOM.render(<App />, document.getElementById('artifact_react'));
        } catch(error) {
            displayError('An error occurred while loading the application.');
        }
        window.addEventListener('error', function(event) {
            displayError(event.message, event.error?.stack);
        });
        function displayError(message, stackInfo) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.createElement('div');
            errorMessage.textContent = message;
            errorContainer.appendChild(errorMessage);
            if(stackInfo) {
                const stackErrorMessage = document.createElement('pre');
                stackErrorMessage.textContent = stackInfo.substring(0, 130);
                errorContainer.appendChild(stackErrorMessage);
            }
            errorContainer.style.display = 'block';
        }
    </script>
</body>
</html>

[end of index.html]

[end of index.html]
